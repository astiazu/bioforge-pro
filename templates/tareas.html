<!-- templates/tareas.html -->
{% extends "base.html" %}
{% block title %}ðŸ“Š Panel de Tareas{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4 mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary"><i class="fas fa-tasks me-2"></i> GestiÃ³n de Tareas</h2>
        <a href="{{ url_for('routes.nueva_tarea') }}" class="btn btn-primary btn-lg px-4">
            <i class="fas fa-plus-circle me-2"></i> Nueva Tarea
        </a>
    </div>

    <!-- KPIs principales -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-start border-4 border-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Total</p>
                            <h4 class="mb-0">{{ tasks|length }}</h4>
                        </div>
                        <i class="fas fa-tasks fa-2x text-primary opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-start border-4 border-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Pendientes</p>
                            <h4 class="mb-0">{{ tasks|selectattr('status','equalto','pending')|list|length }}</h4>
                        </div>
                        <i class="fas fa-clock fa-2x text-warning opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-start border-4 border-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Completadas</p>
                            <h4 class="mb-0">{{ tasks|selectattr('status','equalto','completed')|list|length }}</h4>
                        </div>
                        <i class="fas fa-check-circle fa-2x text-success opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-start border-4 border-info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Asistentes</p>
                            <h4 class="mb-0">{{ assistants_count }}</h4>
                        </div>
                        <i class="fas fa-users fa-2x text-info opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endwith %}

    <!-- Mostrar botÃ³n de WhatsApp si existe en sesiÃ³n -->
    {% if session.get('whatsapp_url') %}
    <div id="whatsapp-alert" class="alert alert-success text-center mb-4">
        <p><strong>ðŸ“² Â¡Tarea actualizada! EnvÃ­a el mensaje por WhatsApp:</strong></p>
        <a 
            href="{{ session.get('whatsapp_url') }}" 
            target="_blank" 
            class="btn btn-success btn-lg"
            onclick="confirmarEnvio(event)"
        >
            <i class="fab fa-whatsapp me-2"></i> Abrir WhatsApp
        </a>
    </div>

    <script>
    function confirmarEnvio(e) {
        fetch('{{ url_for("routes.limpiar_whatsapp_session") }}', { method: 'POST' })
            .finally(() => {
                const alert = document.getElementById('whatsapp-alert');
                alert.classList.remove('alert-success');
                alert.classList.add('alert-info');
                alert.innerHTML = '<p><strong>âœ… Mensaje abierto. Gracias por comunicarte.</strong></p>';
                
                // Desaparece a los 3 segundos
                setTimeout(() => alert.remove(), 3000);
            });
    }
    </script>
    {% endif %}

    <!-- GrÃ¡ficos -->
    <div class="row g-4 mb-5">
        <!-- EvoluciÃ³n de tareas por estado -->
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>EvoluciÃ³n de Tareas</h6>
                    <small class="text-muted">Ãšltimos 30 dÃ­as</small>
                </div>
                <div class="card-body" style="height: 350px;">
                    <div id="chart-evolucion"></div>
                </div>
            </div>
        </div>

        <!-- DistribuciÃ³n por asistente -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-user-tag me-2 text-success"></i>Tareas por Asistente</h6>
                </div>
                <div class="card-body" style="height: 350px;">
                    <div id="chart-asistentes"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <!-- Asistente -->
                <div class="col-md-4">
                    <label for="assistant" class="form-label">Filtrar por asistente</label>
                    <select id="assistant" name="assistant" class="form-select">
                        <option value="">Todos</option>
                        {% for a in assistants %}
                            <option value="{{ a.id }}" {% if request.args.get('assistant') == a.id|string %}selected{% endif %}>
                                {{ a.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Estado -->
                <div class="col-md-4">
                    <label for="status" class="form-label">Filtrar por estado</label>
                    <select id="status" name="status" class="form-select">
                        <option value="">Todos</option>
                        <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>Pendiente</option>
                        <option value="in_progress" {% if request.args.get('status') == 'in_progress' %}selected{% endif %}>En progreso</option>
                        <option value="completed" {% if request.args.get('status') == 'completed' %}selected{% endif %}>Completada</option>
                        <option value="cancelled" {% if request.args.get('status') == 'cancelled' %}selected{% endif %}>Cancelada</option>
                    </select>
                </div>

                <!-- Fecha -->
                <div class="col-md-4">
                    <label for="date" class="form-label">Filtrar por fecha lÃ­mite</label>
                    <input type="date" id="date" name="date" class="form-control"
                        value="{{ request.args.get('date', '') }}">
                </div>

                <!-- BotÃ³n -->
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-2"></i>Aplicar filtros
                    </button>
                    <a href="{{ url_for('routes.ver_tareas') }}" class="btn btn-secondary">
                        Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>
    <!-- Tabla de tareas -->
    <div class="card shadow-sm">
        <div class="card-header bg-white border-bottom">
            <h6 class="mb-0">ðŸ“‹ Lista de Tareas</h6>
        </div>
        <div class="card-body p-0">
            {% if tasks %}
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>TÃ­tulo</th>
                            <th>Asistente</th>
                            <th>Fecha LÃ­mite</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in tasks %}
                        <tr>
                            <td class="align-middle">
                                <div class="d-flex align-items-center">
                                    {% if t.status == 'completed' %}
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                    {% elif t.status == 'in_progress' %}
                                        <i class="fas fa-spinner fa-spin text-info me-2"></i>
                                    {% else %}
                                        <i class="far fa-circle text-secondary me-2"></i>
                                    {% endif %}
                                    <span class="fw-medium">{{ t.title }}</span>
                                </div>
                            </td>
                            <td class="align-middle">
                                <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
                                    {{ t.assistant.name }}
                                </span>
                            </td>
                            <td class="align-middle">
                                {% if t.due_date %}
                                    <span class="d-flex align-items-center">
                                        <i class="fas fa-calendar-alt me-2 text-muted"></i>
                                        {{ t.due_date.strftime('%d/%m/%Y') }}
                                        {% if t.due_date < today and t.status != 'completed' %}
                                            <span class="ms-2 badge bg-danger bg-opacity-10 text-danger small">Atrasada</span>
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span class="text-muted">Sin fecha</span>
                                {% endif %}
                            </td>
                            <td class="align-middle">
                                <span class="badge {{ status_labels[t.status].class }} px-3 py-2">
                                    {{ status_labels[t.status].text }}
                                </span>
                            </td>
                            <td class="align-middle">
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('routes.editar_tarea', task_id=t.id) }}" 
                                       class="btn btn-sm btn-outline-primary" 
                                       title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-tasks fa-3x text-muted mb-3" style="opacity: 0.3;"></i>
                <h5>No tienes tareas asignadas</h5>
                <p class="text-muted mb-4">Crea tu primera tarea para comenzar a organizar tu equipo.</p>
                <a href="{{ url_for('routes.nueva_tarea') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i> Crear Primera Tarea
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    const dataEvolucion = {{ data_evolucion | tojson }};
    const dataAsistentes = {{ assistants_distribution | tojson }};

    // === EvoluciÃ³n de tareas ===
    const tracePend = {
        x: dataEvolucion.map(d => d.name),
        y: dataEvolucion.map(d => d["Pendientes"]),
        mode: "lines+markers",
        name: "Pendientes",
        line: { color: "orange", width: 2 }
    };
    const traceProg = {
        x: dataEvolucion.map(d => d.name),
        y: dataEvolucion.map(d => d["En progreso"]),
        mode: "lines+markers",
        name: "En progreso",
        line: { color: "blue", width: 2 }
    };
    const traceComp = {
        x: dataEvolucion.map(d => d.name),
        y: dataEvolucion.map(d => d["Completadas"]),
        mode: "lines+markers",
        name: "Completadas",
        line: { color: "green", width: 2 }
    };

    const layoutEvolucion = {
        margin: { t: 30 },
        xaxis: {
            rangeslider: { visible: true },
            rangeselector: {
                buttons: [
                    { count: 7, label: "7d", step: "day", stepmode: "backward" },
                    { count: 14, label: "14d", step: "day", stepmode: "backward" },
                    { count: 30, label: "30d", step: "day", stepmode: "backward" },
                    { step: "all", label: "Todo" }
                ]
            }
        },
        yaxis: { title: "Cantidad" },
        legend: { orientation: "h", y: -0.3 },
        hovermode: "x unified"
    };

    Plotly.newPlot("chart-evolucion", [tracePend, traceProg, traceComp], layoutEvolucion, {
        responsive: true,
        displaylogo: false,
        modeBarButtonsToAdd: ["drawline", "drawrect", "eraseshape"],
        toImageButtonOptions: { format: "png", filename: "evolucion_tareas", scale: 2 }
    });

    // === DistribuciÃ³n asistentes ===
    const tracePie = {
        labels: dataAsistentes.map(d => d.name),
        values: dataAsistentes.map(d => d.task_count),
        type: "pie",
        hole: 0.5,
        textinfo: "label+percent",
        insidetextorientation: "radial"
    };

    const layoutPie = {
        margin: { t: 30 },
        annotations: [
            { font: { size: 14 }, showarrow: false, text: "Tareas", x: 0.5, y: 0.5 }
        ],
        legend: { orientation: "h", y: -0.2 }
    };

    Plotly.newPlot("chart-asistentes", [tracePie], layoutPie, {
        responsive: true,
        displaylogo: false,
        modeBarButtonsToAdd: ["drawcircle", "eraseshape"],
        toImageButtonOptions: { format: "png", filename: "distribucion_asistentes", scale: 2 }
    });
</script>
{% endblock %}

{% block styles %}
<style>
    .card { border-radius: 0.5rem; }
    .card-header {
        border-top-left-radius: 0.5rem !important;
        border-top-right-radius: 0.5rem !important;
    }
    .opacity-25 { opacity: 0.25 !important; }
    .bg-opacity-10 { background-color: rgba(0,0,0,0.1) !important; }
    .border-start { border-left: 4px solid #dee2e6 !important; }
    .border-primary { border-color: #0d6efd !important; }
    .border-warning { border-color: #ffc107 !important; }
    .border-success { border-color: #198754 !important; }
    .border-info { border-color: #0dcaf0 !important; }
</style>
{% endblock %}