<!-- templates/public/calendario_turnos.html -->
{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8">
            <h3>{{ doctor.username }} - Agenda de visitas</h3>
            <p class="text-muted">Selecciona un día con disponibilidad para ver los horarios.</p>
            <div id="calendar"
                 data-doctor-id="{{ doctor.id }}"
                 data-clinic-id="{{ clinic.id }}">
            </div>
        </div>
        <div class="col-lg-4" id="horarios-container" style="display: none;">
            <h5 id="selected-date-title"></h5>
            <div id="horarios"></div>
        </div>
    </div>
</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const doctorId = calendarEl.dataset.doctorId;
    const clinicId = calendarEl.dataset.clinicId;

    fetch(`/api/dias-disponibles/${doctorId}/${clinicId}`)
        .then(response => response.json())
        .then(data => {
            const availableDays = new Set(data.available_days);

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                dayCellDidMount: function (info) {
                    const dateStr = info.date.toISOString().split('T')[0];
                    if (availableDays.has(dateStr)) {
                        info.el.style.backgroundColor = '#d4edda';
                        info.el.style.cursor = 'pointer';
                    }
                },
                dateClick: function (info) {
                    // ✅ Usa info.dateStr directamente
                    const fechaStr = info.dateStr;

                    if (availableDays.has(fechaStr)) {
                        // ✅ Mostrar la fecha local
                        document.getElementById('selected-date-title').textContent = 
                            `Horarios disponibles - ${formatearFecha(fechaStr)}`;
                        cargarHorarios(fechaStr);
                    } else {
                        alert('No hay disponibilidad en esta fecha.');
                    }
                }
            });
            calendar.render();
        })
        .catch(err => {
            console.error('Error cargando días disponibles:', err);
            alert('Error al cargar el calendario. Recarga la página.');
        });

    function cargarHorarios(fecha) {
        fetch(`/api/horarios/${doctorId}/${clinicId}/${fecha}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('horarios-container');
                const title = document.getElementById('selected-date-title');
                const horariosDiv = document.getElementById('horarios');

                container.style.display = 'block';
                title.textContent = `Horarios disponibles - ${formatearFecha(fecha)}`;

                if (data.length === 0) {
                    horariosDiv.innerHTML = '<p class="text-muted">No hay horarios disponibles.</p>';
                } else {
                    horariosDiv.innerHTML = `
                        <div class="d-flex flex-wrap gap-2">
                            ${data.map(slot => `
                            <div class="card border-success" style="width: 160px;">
                                <div class="card-body text-center p-2">
                                    <p class="h5 text-success mb-2">${slot.time}</p>
                                    <form method="POST" action="/turno/reservar" class="m-0">
                                        <input type="hidden" name="availability_id" value="${slot.id}">
                                        <input type="text" name="patient_name" placeholder="Tu nombre" required class="form-control form-control-sm">
                                        <input type="email" name="patient_email" placeholder="Tu email" required class="form-control form-control-sm mt-1">
                                        <button type="submit" class="btn btn-success btn-sm w-100 mt-2">Reservar</button>
                                    </form>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                    `;
                }
            })
            .catch(err => {
                console.error('Error:', err);
                document.getElementById('horarios').innerHTML = '<p class="text-danger">Error al cargar horarios.</p>';
            });
    }

    function formatearFecha(dateString) {
        const options = { 
            weekday: 'long',
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        };
        return new Date(dateString + 'T00:00:00').toLocaleDateString('es-ES', options);
    }
});
</script>
{% endblock %}