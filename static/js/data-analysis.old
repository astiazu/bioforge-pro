// static/js/data-analysis.js
document.addEventListener('DOMContentLoaded', function () {
    const csvFile = document.getElementById('csvFile');
    const uploadForm = document.getElementById('uploadForm'); // ‚úÖ Nuevo
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const dataPreview = document.getElementById('dataPreview');
    const chartConfig = document.getElementById('chartConfig');
    const chartDisplay = document.getElementById('chartDisplay');
    const dataTableHead = document.getElementById('dataTableHead');
    const dataTableBody = document.getElementById('dataTableBody');
    const xColumn = document.getElementById('xColumn');
    const yColumn = document.getElementById('yColumn');
    const chartType = document.getElementById('chartType');
    const generateChartBtn = document.getElementById('generateChart');
    const dataChart = document.getElementById('dataChart').getContext('2d');
    const resetBtn = document.getElementById('resetBtn'); // ‚úÖ Nuevo

    let fileId = null;
    let chartInstance = null;

    // ‚úÖ Manejar submit del formulario
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = csvFile.files[0];
        if (!file) return showStatus('error', 'Selecciona un archivo CSV');

        // ‚úÖ Validar tama√±o (opcional)
        if (file.size > 10 * 1024 * 1024) {
            showStatus('error', 'El archivo es demasiado grande (m√°x. 10MB)');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            showStatus('info', '‚¨ÜÔ∏è Subiendo y procesando archivo...');
            const response = await fetch('/upload_csv', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (response.ok) {
                fileId = result.file_id;
                console.log("‚úÖ file_id recibido:", fileId);

                // ‚úÖ Resetear estado anterior
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
                chartDisplay.style.display = 'none';

                showStatus('success', '‚úÖ ¬°CSV cargado correctamente!');
                renderDataPreview(result);
                setupColumnSelectors(result.columns);
                dataPreview.style.display = 'block';
                chartConfig.style.display = 'block';
            } else {
                showStatus('error', `‚ùå Error del servidor: ${result.error || 'Desconocido'}`);
            }
        } catch (error) {
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                showStatus('error', '‚ö†Ô∏è Servidor no disponible. ¬øEst√° corriendo tu app local?');
            } else {
                showStatus('error', `‚ùå Error: ${error.message}`);
            }
            console.error("Error en subida de CSV:", error);
        }
    });

    // ‚úÖ Bot√≥n de limpiar
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            csvFile.value = '';
            fileId = null;
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            dataPreview.style.display = 'none';
            chartConfig.style.display = 'none';
            chartDisplay.style.display = 'none';
            uploadStatus.innerHTML = '';
            dataTableBody.innerHTML = '';
            dataTableHead.innerHTML = '';
            xColumn.innerHTML = '<option value="">Seleccionar columna...</option>';
            yColumn.innerHTML = '<option value="">Seleccionar columna...</option>';
            showStatus('info', 'üßπ Todo limpio. Sube un nuevo archivo.');
        });
    }

    function renderDataPreview(info) {
        document.getElementById('dataRows').textContent = info.shape[0];
        document.getElementById('dataCols').textContent = info.shape[1];
        document.getElementById('dataMissing').textContent = Object.values(info.missing_values).reduce((a, b) => a + b, 0);
        document.getElementById('dataTypes').textContent = new Set(Object.values(info.dtypes)).size;

        dataTableHead.innerHTML = '<tr>' + info.columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
        dataTableBody.innerHTML = info.preview.map(row => {
            return '<tr>' + info.columns.map(col => `<td>${row[col] !== undefined ? row[col] : ''}</td>`).join('') + '</tr>';
        }).join('');
    }

    function setupColumnSelectors(columns) {
        [xColumn, yColumn].forEach(select => {
            select.innerHTML = '<option value="">Seleccionar columna...</option>';
            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                select.appendChild(option);
            });
        });
    }

    generateChartBtn.addEventListener('click', async () => {
        const x = xColumn.value;
        const y = yColumn.value;
        const type = chartType.value;

        if (!x || !y) {
            alert('Selecciona ambas columnas');
            return;
        }

        if (!fileId) {
            alert('Primero debes subir un CSV');
            return;
        }

        try {
            showStatus('info', 'üìä Generando gr√°fico...');
            const response = await fetch('/analyze-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    file_id: fileId,
                    x_column: x,
                    y_column: y,
                    chart_type: type
                })
            });

            const result = await response.json();
            if (response.ok) {
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(dataChart, {
                    type: result.chart_type === 'scatter' ? 'scatter' : result.chart_type,
                    data: result.chart_data,
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: result.title
                            },
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: x
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: y
                                }
                            }
                        }
                    }
                });
                chartDisplay.style.display = 'block';
                showStatus('success', '‚úÖ Gr√°fico generado');
            } else {
                showStatus('error', `‚ùå Error: ${result.error}`);
            }
        } catch (error) {
            showStatus('error', `‚ùå Error al generar gr√°fico: ${error.message}`);
            console.error('Error:', error);
        }
    });

    function showStatus(type, message) {
        const classes = {
            info: 'text-info',
            success: 'text-success',
            error: 'text-danger'
        };
        uploadStatus.innerHTML = `<small class="${classes[type]}">${message}</small>`;
    }

    // Descargar gr√°fico
    const downloadBtn = document.getElementById('downloadChart');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', () => {
            if (!chartInstance) {
                alert('No hay gr√°fico para descargar');
                return;
            }
            const url = dataChart.canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `grafico-${new Date().toISOString().slice(0,10)}.png`;
            a.click();
        });
    }
});